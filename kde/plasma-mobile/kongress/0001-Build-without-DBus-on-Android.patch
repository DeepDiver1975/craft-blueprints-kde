From 1e909d0d50250c6d3b8a1b15bdf13c2874c69294 Mon Sep 17 00:00:00 2001
From: Nicolas Fella <nicolas.fella@gmx.de>
Date: Tue, 25 May 2021 22:44:30 +0200
Subject: [PATCH] Build without DBus on Android

---
 CMakeLists.txt       |  2 +-
 src/CMakeLists.txt   |  4 ++--
 src/alarmchecker.cpp | 11 +++++++++++
 3 files changed, 14 insertions(+), 3 deletions(-)

diff --git a/CMakeLists.txt b/CMakeLists.txt
index 86db4f0..9f522e2 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -35,7 +35,7 @@ ecm_setup_version(${PROJECT_VERSION}
     VERSION_HEADER ${CMAKE_CURRENT_BINARY_DIR}/version.h
 )
 
-find_package(Qt5 ${QT_MIN_VERSION} REQUIRED NO_MODULE COMPONENTS DBus Core Quick Gui Svg Qml QuickControls2 Network)
+find_package(Qt5 ${QT_MIN_VERSION} REQUIRED NO_MODULE COMPONENTS Core Quick Gui Svg Qml QuickControls2 Network)
 
 find_package(KF5 ${KF5_MIN_VERSION} REQUIRED COMPONENTS Config Kirigami2 I18n CalendarCore CoreAddons)
 
diff --git a/src/CMakeLists.txt b/src/CMakeLists.txt
index e187dc3..b230145 100644
--- a/src/CMakeLists.txt
+++ b/src/CMakeLists.txt
@@ -17,7 +17,7 @@ set(kongress_SRCS
     )
 
 add_executable(kongress ${kongress_SRCS} ${RESOURCES})
-target_link_libraries(kongress PRIVATE Qt5::Core Qt5::Qml Qt5::Quick Qt5::Svg Qt5::QuickControls2 Qt5::Network Qt5::DBus KF5::ConfigCore KF5::I18n KF5::CalendarCore KF5::CoreAddons)
+target_link_libraries(kongress PRIVATE Qt5::Core Qt5::Qml Qt5::Quick Qt5::Svg Qt5::QuickControls2 Qt5::Network KF5::ConfigCore KF5::I18n KF5::CalendarCore KF5::CoreAddons)
 if (BUILD_TESTING)
     target_link_libraries(kongress PRIVATE Qt5::Test)
 endif()
@@ -52,7 +52,7 @@ if (ANDROID)
         draw-arrow-back
     )
 else()
-    target_link_libraries(kongress PRIVATE Qt5::Widgets)
+    target_link_libraries(kongress PRIVATE Qt5::Widgets Qt5::DBus)
 endif()
 
 install(TARGETS kongress ${KF5_INSTALL_TARGETS_DEFAULT_ARGS})
diff --git a/src/alarmchecker.cpp b/src/alarmchecker.cpp
index d6bf3f3..8217ca5 100644
--- a/src/alarmchecker.cpp
+++ b/src/alarmchecker.cpp
@@ -6,23 +6,31 @@
 
 #include "alarmchecker.h"
 
+#ifndef Q_OS_ANDROID
 #include <QDBusInterface>
 #include <QDBusConnection>
 #include <QDBusReply>
+#endif
+
 #include <QDebug>
 
 AlarmChecker::AlarmChecker(QObject *parent) : QObject {parent}
 {
+#ifndef Q_OS_ANDROID
     m_interface = new QDBusInterface {QStringLiteral("org.kde.kongressac"), QStringLiteral("/kongressac"), QStringLiteral("org.kde.kongressac"), QDBusConnection::sessionBus(), this};
+#endif
 }
 
 void AlarmChecker::scheduleAlarmCheck()
 {
+#ifndef Q_OS_ANDROID
     m_interface->call(QStringLiteral("scheduleAlarmCheck"));
+#endif
 }
 
 int AlarmChecker::active()
 {
+#ifndef Q_OS_ANDROID
     auto kongressacActive {false};
 
     QDBusReply<int> reply = m_interface->call(QStringLiteral("active"));
@@ -31,4 +39,7 @@ int AlarmChecker::active()
     }
 
     return kongressacActive;
+#else
+    return false;
+#endif
 }
-- 
2.31.1

