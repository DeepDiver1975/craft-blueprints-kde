From c4f10ce3b53b14f7e02004c3e2a73d64642c646a Mon Sep 17 00:00:00 2001
From: Nicolas Fella <nicolas.fella@gmx.de>
Date: Tue, 8 Mar 2022 14:34:22 +0100
Subject: [PATCH] Build without kglobalaccel on Windows and mac

kglobalaccel is not supported there
---
 .kde-ci.yml                      |  5 ++++-
 CMakeLists.txt                   |  7 ++++++-
 src/CMakeLists.txt               |  5 ++++-
 src/config-khtml.h.cmake         |  1 +
 src/rendering/media_controls.cpp | 11 ++++++++++-
 5 files changed, 25 insertions(+), 4 deletions(-)

diff --git a/.kde-ci.yml b/.kde-ci.yml
index 4d08a91fa4..b6440626e4 100644
--- a/.kde-ci.yml
+++ b/.kde-ci.yml
@@ -22,8 +22,11 @@ Dependencies:
     'frameworks/kparts' : '@same'
     'frameworks/kio' : '@same'
     'frameworks/kwallet' : '@same'
-    'frameworks/kglobalaccel' : '@same'
     'libraries/phonon' : '@stable'
 
+- 'on': ['Linux', 'FreeBSD']
+  'require':
+    'frameworks/kglobalaccel' : '@same'
+
 Options:
   test-before-installing: True
diff --git a/CMakeLists.txt b/CMakeLists.txt
index 4ee68957cb..b7b5adbb55 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -29,7 +29,6 @@ string(REPLACE "-Wsuggest-override" "" CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS}")
 
 find_package(KF5Archive ${KF_DEP_VERSION} REQUIRED)
 find_package(KF5Codecs ${KF_DEP_VERSION} REQUIRED)
-find_package(KF5GlobalAccel ${KF_DEP_VERSION} REQUIRED)
 find_package(KF5I18n ${KF_DEP_VERSION} REQUIRED)
 find_package(KF5IconThemes ${KF_DEP_VERSION} REQUIRED)
 find_package(KF5KIO ${KF_DEP_VERSION} REQUIRED)
@@ -43,6 +42,12 @@ find_package(KF5WidgetsAddons ${KF_DEP_VERSION} REQUIRED)
 find_package(KF5WindowSystem ${KF_DEP_VERSION} REQUIRED)
 find_package(KF5XmlGui ${KF_DEP_VERSION} REQUIRED)
 
+if(NOT WIN32 AND NOT APPLE)
+  find_package(KF5GlobalAccel ${KF_DEP_VERSION} REQUIRED)
+endif()
+
+set(HAVE_KGLOBALACCEL ${KF5GlobalAccel_FOUND})
+
 ecm_setup_version(PROJECT VARIABLE_PREFIX KHTML
                         VERSION_HEADER "${CMAKE_CURRENT_BINARY_DIR}/khtml_version.h"
                         PACKAGE_VERSION_FILE "${CMAKE_CURRENT_BINARY_DIR}/KF5KHtmlConfigVersion.cmake"
diff --git a/src/CMakeLists.txt b/src/CMakeLists.txt
index 5bcedd1649..fef2e8e08b 100644
--- a/src/CMakeLists.txt
+++ b/src/CMakeLists.txt
@@ -606,7 +606,6 @@ target_link_libraries(KF5KHtml
     KF5::Notifications
     KF5::Bookmarks
     KF5::KIOWidgets # KUrlRequester
-    KF5::GlobalAccel
 )
 if(NOT WIN32 AND NOT APPLE AND X11_FOUND)
   target_link_libraries(KF5KHtml PRIVATE Qt5::X11Extras)
@@ -616,6 +615,10 @@ if (KJS_DEBUGGER)
   target_link_libraries(KF5KHtml PRIVATE KF5::KTextEditor)
 endif()
 
+if(TARGET KF5::GlobalAccel)
+  target_link_libraries(KF5KHtml PRIVATE KF5::GlobalAccel)
+endif()
+
 set_target_properties(KF5KHtml PROPERTIES VERSION ${KHTML_VERSION}
                                           SOVERSION ${KHTML_SOVERSION}
                                           EXPORT_NAME KHtml
diff --git a/src/config-khtml.h.cmake b/src/config-khtml.h.cmake
index 729be5d65c..064aac5a34 100644
--- a/src/config-khtml.h.cmake
+++ b/src/config-khtml.h.cmake
@@ -8,6 +8,7 @@
 #cmakedefine01 HAVE_X11
 #cmakedefine01 HAVE_GETPAGESIZE
 #cmakedefine01 HAVE_MMAP
+#cmakedefine01 HAVE_KGLOBALACCEL
 
 #endif /* CONFIG_KHTML_H */
 
diff --git a/src/rendering/media_controls.cpp b/src/rendering/media_controls.cpp
index 5794172db8..b0441ebcbe 100644
--- a/src/rendering/media_controls.cpp
+++ b/src/rendering/media_controls.cpp
@@ -31,9 +31,14 @@
 #include <rendering/render_media.h>
 #include <phonon/videowidget.h>
 #include <ktogglefullscreenaction.h>
-#include <kglobalaccel.h>
 #include <klocalizedstring.h>
 
+#include "config-khtml.h"
+
+#if HAVE_KGLOBALACCEL
+#include <kglobalaccel.h>
+#endif
+
 namespace khtml
 {
 
@@ -65,10 +70,14 @@ void MediaControls::slotToggled(bool t)
 {
     if (t) {
         m_mediaPlayer->videoWidget()->enterFullScreen();
+#if HAVE_KGLOBALACCEL
         KGlobalAccel::self()->setShortcut(m_fullscreen->defaultAction(), QList<QKeySequence>() << Qt::Key_Escape);
+#endif
     } else {
         m_mediaPlayer->videoWidget()->exitFullScreen();
+#if HAVE_KGLOBALACCEL
         KGlobalAccel::self()->removeAllShortcuts(m_fullscreen->defaultAction());
+#endif
     }
 }
 
-- 
2.35.1

